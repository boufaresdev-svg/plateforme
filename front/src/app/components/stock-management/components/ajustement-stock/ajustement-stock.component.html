<div class="categories-management">
  <app-notification></app-notification>
  
  <div class="section-header">
    <h2>Ajustements de Stock</h2>
    <button class="btn-primary" (click)="openAddModal()" [disabled]="loading">
      <span class="icon">+</span>
      Nouvel Ajustement
    </button>
  </div>

  <div class="alert alert-error" *ngIf="errorMessage">{{ errorMessage }}</div>
  <div class="loading-indicator" *ngIf="loading"><span>Chargement...</span></div>

  <div class="search-filters">
    <select class="filter-select" [(ngModel)]="categoryFilter" (change)="loadAjustements()">
      <option value="">Toutes les cat√©gories</option>
      <option *ngFor="let category of categories" [value]="category.id">
        {{ category.nom }}
      </option>
    </select>
    
    <select class="filter-select" [(ngModel)]="marqueFilter" (change)="loadAjustements()">
      <option value="">Toutes les marques</option>
      <option *ngFor="let marque of marques" [value]="marque.id">
        {{ marque.nom }}
      </option>
    </select>
    
    <select class="filter-select" [(ngModel)]="fournisseurFilter" (change)="loadAjustements()">
      <option value="">Tous les fournisseurs</option>
      <option *ngFor="let fournisseur of fournisseurs" [value]="fournisseur.id">
        {{ fournisseur.nom }}
      </option>
    </select>
    
    <select class="filter-select" [(ngModel)]="entrepotFilter" (change)="loadAjustements()">
      <option value="">Tous les entrep√¥ts</option>
      <option *ngFor="let entrepot of entrepots" [value]="entrepot.id">
        {{ entrepot.nom }}
      </option>
    </select>
    
    <select class="filter-select" [(ngModel)]="filterArticleId" (ngModelChange)="filterByArticle()">
      <option value="">Tous les articles</option>
      <option *ngFor="let article of articles" [value]="article.id">
        {{ article.nom }}
      </option>
    </select>
    
    <input type="date" 
           class="filter-select" 
           [(ngModel)]="filterStartDate"
           placeholder="Date d√©but"
           style="max-width: 200px;">
    
    <input type="date" 
           class="filter-select" 
           [(ngModel)]="filterEndDate"
           placeholder="Date fin"
           style="max-width: 200px;">
    
    <button class="btn-secondary" (click)="filterByDateRange()" [disabled]="loading">
      Filtrer
    </button>
    
    <button class="btn-secondary" (click)="loadAjustements()" [disabled]="loading">
      R√©initialiser
    </button>
  </div>

  <div class="categories-table-container" *ngIf="!loading">
    <table class="categories-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Article</th>
          <th>Entrep√¥t</th>
          <th>Qt√© Avant</th>
          <th>Qt√© Apr√®s</th>
          <th>Ajustement</th>
          <th>Utilisateur</th>
          <th>Raison</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ajustement of paginatedAjustements" class="category-row">
          <td>{{ ajustement.dateAjustement | date:'dd/MM/yyyy' }}</td>
          <td class="category-cell">
            <div class="category-name">{{ ajustement.articleNom }}</div>
            <small style="color: #6b7280;">{{ ajustement.articleSku || '-' }}</small>
          </td>
          <td>{{ ajustement.entrepotNom || '-' }}</td>
          <td style="text-align: center;">{{ ajustement.quantiteAvant }}</td>
          <td style="text-align: center;">{{ ajustement.quantiteApres }}</td>
          <td style="text-align: center;">
            <span class="adjustment-badge" 
                  [class.positive]="ajustement.ajustement > 0"
                  [class.negative]="ajustement.ajustement < 0"
                  [class.neutral]="ajustement.ajustement === 0">
              {{ ajustement.ajustement > 0 ? '+' : '' }}{{ ajustement.ajustement }}
            </span>
          </td>
          <td>{{ ajustement.utilisateurNom || '-' }}</td>
          <td class="description-cell">
            <div class="description-text">
              {{ ajustement.raison || '-' }}
            </div>
          </td>
          <td class="actions-cell">
            <button class="btn-action btn-edit" (click)="openEditModal(ajustement)" title="Modifier">
              ‚úèÔ∏è
            </button>
            <button class="btn-action btn-delete" (click)="deleteAjustement(ajustement.id)" title="Supprimer">
              üóëÔ∏è
            </button>
          </td>
        </tr>
        <tr *ngIf="ajustements.length === 0">
          <td colspan="9" class="empty-state">
            <div class="empty-icon">üìä</div>
            <div class="empty-text">Aucun ajustement trouv√©</div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="totalElements > 0">
    <div class="pagination-info">
      Affichage de {{ currentPage * pageSize + 1 }} √† {{ Math.min((currentPage + 1) * pageSize, totalElements) }} sur {{ totalElements }} r√©sultats
    </div>
    <div class="pagination-controls">
      <div class="page-size-selector">
        <label>Afficher:</label>
        <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-select">
          <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
        </select>
      </div>
      <div class="page-buttons">
        <button class="btn-page" [disabled]="currentPage === 0" (click)="onPageChange(0)">
          Premier
        </button>
        <button class="btn-page" [disabled]="currentPage === 0" (click)="onPageChange(currentPage - 1)">
          Pr√©c√©dent
        </button>
        <span class="page-info">Page {{ currentPage + 1 }} sur {{ totalPages }}</span>
        <button class="btn-page" [disabled]="currentPage >= totalPages - 1" (click)="onPageChange(currentPage + 1)">
          Suivant
        </button>
        <button class="btn-page" [disabled]="currentPage >= totalPages - 1" (click)="onPageChange(totalPages - 1)">
          Dernier
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Add/Edit Ajustement -->
<div class="modal" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" 
     tabindex="-1" role="dialog" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-dialog modal-dialog-centered" role="document" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ isEditMode ? 'Modifier l\'Ajustement' : 'Nouvel Ajustement de Stock' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label class="form-label">Article <span class="required">*</span></label>
            <select class="form-control" [(ngModel)]="formData.articleId" name="articleId" 
                    (ngModelChange)="onArticleOrEntrepotChange()" required>
              <option value="">S√©lectionner un article</option>
              <option *ngFor="let article of articles" [value]="article.id">
                {{ article.nom }} ({{ article.sku || article.id }})
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Entrep√¥t <span class="required">*</span></label>
            <select class="form-control" [(ngModel)]="formData.entrepotId" name="entrepotId"
                    (ngModelChange)="onArticleOrEntrepotChange()" required>
              <option value="">S√©lectionner un entrep√¥t</option>
              <option *ngFor="let entrepot of entrepots" [value]="entrepot.id">
                {{ entrepot.nom }}
              </option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Quantit√© Avant (Stock actuel)</label>
              <input type="number" class="form-control" [(ngModel)]="formData.quantiteAvant" 
                     name="quantiteAvant" readonly 
                     style="background-color: #f3f4f6; cursor: not-allowed;"
                     placeholder="S√©lectionnez article et entrep√¥t">
              <small class="text-muted" *ngIf="loadingStock">
                <span style="color: #667eea;">‚è≥ Chargement du stock...</span>
              </small>
              <small class="text-muted" *ngIf="!loadingStock && formData.articleId && formData.entrepotId">
                Quantit√© actuelle en stock : <strong>{{ formData.quantiteAvant }}</strong>
                <span *ngIf="formData.quantiteAvant === 0" style="color: #f39c12;">
                  (Premier ajustement pour cet article dans cet entrep√¥t)
                </span>
              </small>
            </div>
            <div class="form-group">
              <label class="form-label">Quantit√© Apr√®s <span class="required">*</span></label>
              <input type="number" class="form-control" [(ngModel)]="formData.quantiteApres" 
                     name="quantiteApres" required min="0">
            </div>
          </div>

          <div class="adjustment-preview" *ngIf="formData.quantiteAvant !== null && formData.quantiteApres !== null">
            <div class="preview-label">Ajustement calcul√© :</div>
            <div class="preview-value"
                 [class.positive]="formData.quantiteApres > formData.quantiteAvant"
                 [class.negative]="formData.quantiteApres < formData.quantiteAvant"
                 [class.neutral]="formData.quantiteApres === formData.quantiteAvant">
              {{ formData.quantiteApres > formData.quantiteAvant ? '+' : '' }}
              {{ formData.quantiteApres - formData.quantiteAvant }}
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Raison / Motif</label>
            <textarea class="form-control" [(ngModel)]="formData.raison" name="raison" 
                      rows="3" placeholder="Ex: Correction apr√®s inventaire"></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-control" [(ngModel)]="formData.notes" name="notes" 
                      rows="3" placeholder="Informations suppl√©mentaires..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeModal()">
          Annuler
        </button>
        <button type="button" class="btn-primary" (click)="saveAjustement()" [disabled]="loading">
          {{ isEditMode ? 'Mettre √† jour' : 'Ajuster le Stock' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop" [class.show]="showModal" *ngIf="showModal"></div>
